# TIP 597: "string is unicode" and new wtf-8 encoding
	Author:         Jan Nijtmans <jan.nijtmans@gmail.com>
	State:          Draft
	Type:           Project
	Tcl-Version:    8.7
	Tcl-Branch:     tip-597
-----
# Abstract

Currently, there is a discussion going on, about making Tcl more
conform to the Unicode specification. Internally, Tcl allows
to use Unicode codepoints which are not allowed to be exported
to other applications, which makes Tcl non-conformant.
[TIP #574](https://core.tcl-lang.org/tips/doc/trunk/tip/573.md)
makes an attempt to solve this by forbidding the use of surrogates.
This is not the complete set of disallowed characters, but it's
a start.

This TIP attempts another approach. We can allow all characters
internally, but modify the "utf-8" encoder such that any surrogate
or noncharacter (as defined by the Unicode standard) is replaced
by the replacement character U+FFFD. The current "utf-8"
encoding is renamed to "wtf-8". See [WTF-8](https://simonsapin.github.io/wtf-8/)

# Specification

Introduce a new command

* `string is unicode`

This command will return 0 if the string contains at least
one character from the following set, 1 otherwise:

* Surrogates (U+D800 - U+DFFF)
* noncharacters (U+??FFFE - U+??FFFF and U+FDD0 - U+FDEF)

Contrary to other `string is` commands, which adapt to the
evolving Unicode standard, `string is unicode` will not
change any more in future standards. This command cannot be used to
check if a Unicode character is defined for a code point in the
current Unicode standard. If the codepoint is available for a
possible future assignment, `string is unicode` will return 1.

Introduce a new API:

* `int Tcl_UniCharIsUnicode(int character)`

This function returns 1 if `character` is between U+0000 and
U+10FFFE, and it is not a surrogate or a noncharacter.

Introduce a new "utf-8" encoding, and rename the current "utf-8"
encoding to "wtf-8". When converting from internal utf-8 to
external utf-8, any character for which `string is unicode`
returns 0 will be replaced by the replacement character U+FFFD.
When converting from external utf-8 to internal utf-8, nothing
changes: The new utf-8 decoder is forgiving for surrogates
and noncharacters, they can continue to be processed by Tcl as-is.

# Implementation

Implementation is in Tcl branch tip-597

# Compatibility

Since Tcl 8.6's "utf-8" encoder can produce invalid utf-8, and
the new "utf-8" encoder cannot any more, this introduces a
**potential incompatibility** for applications which - illegally -
export invalid utf-8. Applications which - willingly - want to
violate the Unicode standard need to start using the "wtf-8"
encoder in stead. The "utf-8" decoder is unchanged.

# Copyright

This document has been placed in the public domain.
