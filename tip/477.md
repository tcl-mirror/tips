# TIP 477: Modernize the nmake build system
	Author:         Ashok P. Nadkarni <apnmbx-wits@yahoo.com>
	State:          WIP
	Type:           Process
	Vote:           Pending
	Created:        30-Sep-2017
	Post-History:   
	Keywords:       Windows nmake build
-----

# Abstract

Tcl, Tk and extensions are currently built using one of two build
systems - the Tcl Extension Architecture (TEA) and the
Windows/Visual C++ specific nmake based environment. This TIP
addresses only the latter with a view to modernize it to remove
obsolete features, non-optimal build settings, and simplify writing
and maintenance of extensions.

This TIP also serves as the documentation of the reworked nmake build system.

# Background and Rationale

The current nmake-based build system is based on three files in the
`win` directory of a project.

* `makefile.vc` is the master makefile for the project

* `rules.mk` is included by makefile.vc and contains the common
nmake macro definitions and parsing of configuration options shared
by all projects.

* `nmakehlp.c` is a helper application that strives to overcome
the extremely primitive functionality of `nmake`. It is invoked from
rules.mk to check for supported compiler options, simple string
parsing etc.

As currently implemented, the system has several drawbacks including
duplication of code making maintenance difficult, unnecessarily
verbose extension makefiles, and inconsistent application of compiler
options.

## Avoiding duplication of code

In principle, `rules.mk` and `nmakehlp.c` should be shared across Tcl,
Tk and all extensions. In practice, each has its own copy leading to
divergence between the various copies and the resulting maintenance
headaches. Currently, in the 
author found every single extension, including Tk, had diverged from
Tcl. This means updates for new compilers, changes in Tcl build
configuration (e.g. -DUNICODE) do not make their way into extensions.
Moreover, making fixes involves individually fixing extensions, some
of which are orphaned.

The first goal is therefore to *allow each extension, including Tk,
to be built off Tcl's master copy (either installed or from source)
without having to maintain its own*.

## Simplifying extension makefiles

In addition, creating a `makefile.vc` for even a simple extension
involves a lot of unnecessary boilerplate leading to
copy-n-paste-itis and attendant problems. For the vast majority
of "standard" extensions, implicit rules, standard targets,
installation etc. should be automatically handled. Ideally, the
`makefile.vc` should specify only the project name and list of object
files. All else should be automatically taken care off.

Thus, a secondary goal is to *simplify the writing of extension
makefiles to a minimalist form that reduces the boilerplate to
extension-specific configuration*.

The following makefile should suffice to build DLL,
static and debug versions of an extension with standard targets
like `install`, `clean` etc. It will also automatically perform
ancillary tasks such as embedding a Windows version resource in
the generated binary without the extension writer having to
write a resource definition file.

>
	PROJECT=sample
	!include "rules-ext.vc"
	PRJ_OBJS = $(TMP_DIR)\sample.obj \
	               $(TMP_DIR)\util.obj
	!include "targets.vc"

For more complex extensions, the build system should be incrementally
customizable using "building blocks".

## Auditing compiler configuration

There are some bugs, inconsistencies and misconfiguration of compiler
options in the various incarnations of the extension
makefiles. Examples include unoptimized release builds in some
important extensions like Tk and Sqlite, differing floating point
conformance options in debug and release builds even within Tcl and so
on.

Therefore, *a standard set of documented `nmake` macros are defined to
ensure consistency across build configurations*.

## Non-goals

It is not the intent of this TIP to look at alternatives to
nmake. There is already the TEA based system for those who prefer to
use it.

Certain limitations in the current nmake system, in particular
the requirement that there be no spaces in the source directories path
are not addressed.

# Command line interface

There will be no changes to the command line interface used to build
Tcl and extensions using nmake except for removal of some obsolete
features.

    nmake /f makefile.vc ?targets? ?macros? 

The targets are as always defined by the makefile. However, the system
also has standard predefined targets that makes it unnecessary for the
extension makefile to define targets in many common cases. These
are detailed later.

## Build configuration macros

The macros passed on the command line are for the most part the same
as in the current system. They specify the build configuration such as
whether an extension is built as a static or shared library,
instrumentation, generation of debug information and so on. The most
commonly useful macros and their possible values are listed below.
For a full list, see the comments in `rules.vc` file.

The `OPTS` macro controls the build configuration for the compiler and
linker. Its value is a comma-separated list of option values, the more
common options being listed in the table below.

>
Option | Effect
-------|-------
`none`|Nullifies other options even if they are specified.
`static` | Builds the module as a static library instead of the default shared library
`pdbs` | Generates PDB files with symbol information even for release builds
`symbols` | Builds a debug version (no optimization, debug C runtime, PDB's)
`staticpkg` | Specifies `registry` and `dde` extensions should be statically bound (`tclsh` and `wish` only)

The `STATS` macro, also specified as a comma-separated list,
controls generation of instrumentation code as shown
below. This is relevant only for building Tcl itself, not extensions.

>
Option|Effect
------|------
`none`|Turns off all instrumentation irrespective of other options being specified.
`memdbg`|Enables instrumentation of memory allocation.
`compdbg`|Enables byte compiler logging for debugging purposes.

The `CHECKS` macro configure additional compiler checks and warnings.

>
Option|Effect
------|------
`none`|Turns off other `CHECKS` options even if specified.
`nodep`|Disables support for deprecated functions.
`fullwarn`|Cranks up the compiler warnings level.
`64bit`|Enables 64-bit portability warnings.

The following command will generate a static library with PDB debug
information, memory instrumentation, full warnings and disabling
of deprecated functions.

>
    nmake /f makefile.vc OPTS=static,pdbs STATS=memdbg CHECKS=nodep,fullwarn

# Specification

## Distributing the nmake build system

To eliminate the issue of divergence between the nmake support files
as well as the need for continual maintenance and update, the files
`rules.vc`, `nmakehlp.c` and `targets.vc` will be installed as part
of a Tcl install in a similar fashion to `tclconfig.sh`,
`tclstub86.lib` etc. except that they will be placed in the
`lib\nmake` subdirectory under the Tcl installation's root directory.

These files will also be copied to each extension's source repository
as is (supposed to be) done today. *However, this is only a one-time
copy and unlike the current system, it is not required to be done
every time Tcl's version of these files change.* This also allows the
extension to be built against older versions of Tcl that do not
include these files in their installation.

## The `rules-ext.vc` file

The `rules-ext.vc` file is intended to be included by the extension's
makefile to locate and load the latest compatible `rules.vc` file.  It
checks if the installed Tcl has copies of `rules.vc` and `nmakehlp.c`
that are newer versions than the ones in the extension sources, and if
so uses them instead of the extension's copies. In the case of
extensions that build against the Tcl source (as opposed to a Tcl
installation), it checks the versions in the Tcl source directory in a
similar manner.

The compilation rules are versioned via the `RULES_VERSION_MAJOR` and
`RULES_VERSION_MINOR` macros defined in `rules.vc`. 
Versioning is similar to Tcl's in how major and minor versions are
treated. When comparing versions, the files in the Tcl installation
are used if they have the same major version as that in the
extension's rules file and their minor version is the equal or greater. 

## The `nmakehlp.c` program
The `nmakehlp.c` program has the same purpose and functionality as in
the current system. It is unchanged and not detailed here. It is 
compiled and invoked on the fly from nmake for some utility purposes
such as extracting versions, searching for strings etc.

## The `rules.vc` file

This is the heart of the current nmake system and remains so, with
enhancements to include as much of project-independent functionality
as possible. The file is responsible for

* Determining the compiler environment including target architecture,
supported compiler switches etc.

* Parsing any options and macros supplied by the user on the command
line

* Extracting version numbers, include paths etc.

* Defining compiler and linker switches, output paths, and standard
targets based on the above.

It is intended that there will be only one "master" `rules.vc` file,
the one in the Tcl repository where all changes are made. Extensions
will have unmodified copies of this if they need to be build against
older versions of Tcl. Otherwise, they will use the one installed with
Tcl or from the Tcl sources if building against the latter.

## The `targets.vc` file

This file, optionally included by the extension's master makefile,
defines some standard targets that relieves the extension from having
to define its own. It is separated from `rules.vc` so as to permit
master makefile to modify macros set by `rules.vc` before they
are expanded in the target rules.

## Makefile for a basic Tcl extension

**NOTE:** By convention, makefiles using the nmake system are named
`makefile.vc`. Here we refer to them simply as makefile.

As stated earlier, in the simplest case, the following serves as a
complete makefile for a Tcl extension.

>
	PROJECT=sample
	!include "rules-ext.vc"
	PRJ_OBJS = $(TMP_DIR)\sample.obj \
	               $(TMP_DIR)\util.obj \
	!endif
	!include "targets.vc"

Only two macros need be defined to build an Tcl extension with an
additional one required for a Tk extension.

>
Macro|Description
-----|-----------
`PROJECT`|Name of the package. Must be defined before including `rules-ext.vc`.
`PRJ_OBJS`|List of object and resource files for building the extension. The object files must be prefixed with `$(TMP_DIR)\` exactly as shown above.
`PROJECT_REQUIRES_TK`|Define as `1` before including `rules-ext.vc` if the extension is a Tk extension. Do **not** define for a Tcl-only extension.

The lines must be in the order shown with `PROJECT` defined before
inclusion of `rules-ext.vc` and `PROJECT_OBJS` after. The standard
targets, defined in `targets.vc`, are included last.

This suffices to generate shared, static and debug versions of the
extension by invoking `nmake` as

>
	nmake /f makefile.vc INSTALLDIR=/path/to/tcl
	nmake /f makefile.vc INSTALLDIR=/path/to/tcl OPTS=static
	nmake /f makefile.vc INSTALLDIR=/path/to/tcl OPTS=debug

respectively. In addition, it also includes targets for installation
so that

>
    nmake /f makefile.vc INSTALLDIR=/path/to/tcl install

will install the extension including generation of a pkgIndex.tcl
file if necessary. Additional other targets are described later.

In case of a Tk extension, the following line is needed
before including `rules-ext.vc`.

>
    PROJECT_REQUIRES_TK = 1

## Location of Tcl and Tk directories

Building an extension requires Tcl, and optionally Tk, header files
and libraries. The nmake build system locates directories in the
following order:

The installation directory is specified via the `INSTALLDIR` macro on
the command line. If unspecified, this defaults to `C:\Tcl`.
**NOTE**: this is a change from the current default of
`C:\Program Files\Tcl` because the latter may not have access
permissions for the user.

The location of the Tcl header files and libraries is specified
with the `TCLDIR` macro.

* If the macro `TCLDIR` is defined on the command line, it is used as
  the location of the Tcl root directory. This is generally the
  directory containing an installed Tcl but could also point to the
  root of a Tcl source tree if the extension requires Tcl internal
  headers (not recommended).

* If `TCLDIR` is not defined, the macro `INSTALLDIR` is treated as the
  Tcl root directory **if** the directory exists and contains the expected
  header files.

* As a last resort, the directory `../../tcl` is checked and if
  containing the expected header files, used as the value of `TCLDIR`.

* If the header files still cannot be located, an error is generated.

The macros `_INSTALLDIR` and `_TCLDIR` are generated from `INSTALLDIR`
and `TCLDIR` respectively and contain the native form of the path
(using backslashes as directory separators).

In the case of extensions, the macro `TCLINSTALL` is set to `1` if the
extension is being built against an installed Tcl and `0` if it is
built against Tcl sources. For Tk extensions, the macro `TKINSTALL` is
set similarly depending on whether the extension is being built
against an installed Tk or against Tk sources.


## Location of extension sources and implicit rules

The basic makefile shown earlier assumes the following directory
structure for the extension sources:

>
Subdirectory|Macro|Description
---|---|---
`generic`|`GENERICDIR`|Directory containing platform-neutral source files.
`win`|`WINDIR`|Directory containing Windows specific source files.
`compat`|`COMPATDIR`|Directory with additional source files implementing functions not present on all platforms.
`doc`|`DOCDIR`|Directory containing documentation files.
`demos`|`DEMODIR`|Directory containing any demo files.
`tools`|`TOOLSDIR`|Directory containing any build tools.

Only the `GENERICDIR`, `WINDIR` and `COMPATDIR` macros are used 
by `rules.vc` file. Implicit rules are defined to generate the object
files corresponding to sources in any of these directories. If the
source directories are named differently, the corresponding macro
can be defined appropriately **before** including `rules-ext.vc`.

So for example, if your generic sources were in directory `src`, the
makefile would be modified as

>
	PROJECT = sample
	GENERICDIR = ..\src
	!include "rules-ext.vc"
    ...rest remains same...

In case there are additional directories containing sources, you will
have to define an additional implicit rule for each such
directory. For example, if the directory `extrasrc` contained the
additional sources, you would add the lines below after including
`rules-ext.vc`.

>
    EXTRADIR = $(ROOT)\extrasrc

    {$(EXTRADIR)}.c{$(TMP_DIR)}.obj::
	        $(cc32) $(pkgcflags) -Fo$(TMP_DIR)\ @<<
    $<
    <<

Here `cc32` and `pkgcflags` are standard macros defined within
`rules.vc`. These are described later.

The `DOCDIR`, `DEMODIR` and `TOOLSDIR` macros are only defined
as conveniences for the parent makefile.

## Output directories and file names

Based on the options specified on the command line, compiler version
and target architecture, the following macros are defined:

Macro|Description
-----|-----------
`OUT_DIR`|Directory to place output executables and libraries
`TMP_DIR`|Directory to place all the object files

The output directory path placed in `OUT_DIR` has the form
`Release_COMPILERVERSION` for x86 builds and
`Release_AMD64_COMPILERVERSION` for x64 builds (the discrepancy
in inclusion of architecture is historical).

The object files directory path placed in `TMP_DIR` has the form


## Implicit rules

TBD

## Compiler and link flags

TBD

## Windows resource files

TBD

## TBD - extending targets

There will be cases where the above does not suffice. For example,
the default rules do not generate and install
documentation as Tcl extensions do not have a common format and
structure for the same. In simple cases like this, the appropriate
target can be extended with additional commands:

>
    install: install-docs
    $(CPY) $(DOCDIR)\*.html "$(DOC_INSTALL_DIR)"

Note `CPY`, `DOCDIR` and `DOC_INSTALL_DIR` are all predefined or
computed macros within rules.vc.

In more complicated cases, the default make rules can be customized
through definition of macros that control it before including the
`rules-ext.vc` file in the parent makefile. In the extreme case,
the parent makefile can ignore the implicit rules and targets defined
by the system and simply make use of a standard set macros that
encapsulate the compiler and linker options to be used.

The next few sections go into more detail about using the nmake build
system and its customization.


# Reference Implementation

The vc-reform branch in the core.tcl.tk repositories contains work-in-progress.

# Copyright

This document has been placed in the public domain.

