# TIP 430: Add basic ZIP archive support to Tcl
	Author:         Sean Woods <yoda@etoyoc.com>
	Author:         Donal Fellows <donal.k.fellows@manchester.ac.uk>
	Author:         Poor Yorick <tk.tcl.tip@pooryorick.com>
	Author:         Harald Oehlmann <oehhar@users.sourceforge.net>
	State:          Draft
	Type:           Project
	Vote:           Pending
	Created:        03-Sep-2014
	Post-History:
	Keywords:       virtual filesystem,zip,tclkit,boot,bootstrap
	Tcl-Version:    8.7
-----

# Abstract

This proposal will add basic support for mounting zip archive files as virtual
filesystems to the Tcl core.

# Target Tcl-Version

This TIP targets TCL Version 8.7

# Rationale

Tcl/Tk relies on the presence of a file system containing Tcl scripts for
bootstrapping the interpreter.  When dealing with code packed in a
self-contained executable, a chicken-and-egg problem arises when developers
try to provide this bootstrap from their attached VFS with extensions like
TclVfs.  TclVfs runs in the Tcl interpreter.  The interpreter needs
_init.tcl_, which would mean that the filesystem containing _init.tcl_ is
not present until after TclVfs mounts it, yet that mount cannot happen until
after _init.tcl_ has been loaded. Bootstrap filesystem mounts require
built-in support for the filesystem that they use.

With the inclusion of Zlib in the core \(starting with 8.6, [[234]](234.md)\), all that is
required to implement a zip file system based VFS is to add a C-level VFS
implementation to decode the zip archive format. Thus: this project.

Note that we are prioritizing the zip archive format also because it is
practical to generate the files without a Tcl installation being present; it
is a format with widespread OS support. This makes it much easier to bootstrap
a build of Tcl that uses it without requiring a native build of tclsh to be
present.

# Specification

There shall be new commands added to safe interpreters within Tcl. All of which
shall be in the **::zipfs** namespace. These commands shall include:

 * **zipfs::mount** ?_archive_? ?_mountpoint_?

     > Mounts the ZIP file _archive_ at the location given by _mountpoint_,
     > which will default to **zipfs:/_archive_** if absent. With no arguments
     > this command describes all current mounts, returning a list of pairs.

 * **zipfs::unmount** _archive_

	 > Unmounts the ZIP file _archive_, which must have been previously mounted.

Safe interpreters will not be given the mount or unmount commands.
Already mounted file systems will be available via the **glob** and **file**
commands. These commands, and any commands related to building
archives will be marked with the unsafe bit within the **zipfs** ensemble,
and will be removed from any interpreter through the normal mechanism
to hide unsafe commands within the core.

# Implementation

I have adapted Richard Hipp's work on Tcl As One Big Executable \(TOBE\) to
operate inside of a modern Tcl. That implementation consists of one C file
\(_tclZipvfs.c_\).  I have also prepared new behaviors for inside of
**Tcl\_AppInit\(\)** to detect if a zip filesystem is attached to the current
executable, and how to extract a "_main.tcl_" as well as the initial file
systems for both Tcl and Tk.

This work is checked in as the "_core\_zip\_vfs_" branch on both Tcl and Tk.

# Mount Point

Zipfs adopts the metaphor from the tclvfs family of tools of _protocol_:/.
This breaks from the tradition of mounting volumes under / or **info nameofexecutable**
that other zipfs implementations use. Volumes may be mounted at any point under
zipfs:/, and if a mount point does not start with zipfs:/ the path will be
considered relative to zipfs:/. This conventions avoids some confusing interactions
between **file normalize** and **glob** that differ between Windows and Unix and
make building global paths either hop volumes or interact with the native file system.


# C API

* **int TclZipfs_Init\(Tcl\_Interp \*interp\);**

    > Initializes the C API for Zipfs. If called with a non-null _interp_, adds
    > the commands for the zipfs Tcl API to the interpreter. Returns
    > **TCL\_OK** on success, and **TCL\_ERROR** in  all other cases.

* **int TclZipfs_Mount\(Tcl\_Interp \*interp, const char \*zipname, const char \*mntpt, const char \*passwd\);**

    > Mounts a zip file _zipname_ to the mount point _mntpt_. If _passwd_ is
    > non-null, that string is used as the password to decrypt the contents.
    > _mntpnt_ will always be relative to **zipfs:**

* **int TclZipfs_Unmount\(Tcl\_Interp \*interp, const char \*zipname\);**

    > Unmount the file system created by a prior call to **TclZipfs_Mount\(\)**

## Interactions with the Tcl startup sequence

The mount and unmount commands are usable within the core as just another
feature engine. A call to **TclZipfs_Init\(\)** will be inserted into
_tclBasic.c_, immediately after the code to initialize zlib.

A modified shell \(`tclkit.exe`\) will be generated by Make. This shell will:

* Check if the executable has a zip archive attached. If so, that archive shall
  be mounted as **zipfs:/app**.

* If **zipfs:/app** is present the interpreter will look for
  **boot/tcl/init.tcl**. If that file is present, the location for
  **$tcl\_library** will be set to **zipfs:/app/boot/tcl**.

* If the app does not present a **zipfs:/app/boot/tcl** file system, Check if the libtcl dynamic
  library has a zip archive attached, or libtcl.zip file is present in the same
  location as the libtcl shared library. If so, that archive shall be mounted
  as **zipfs:/tcl_library**. The location for  **$tcl\_library** will be set to
  **zipfs:/tcl_library**.

* If the app does not present a **zipfs:/app/boot/tk** file system, Check if the libtk dynamic
  library has a zip archive attached, or libtk.zip file is present in the same
  location as the libtcl shared library. If so, that archive shall be mounted
  as **zipfs:/tk_library**. The location for  **$tk\_library** will be set to
  **zipfs:/tk_library**.

* If **zipfs:/app** is present the interpreter will look for **boot/tk/tk.tcl**.
  If present the location for **$tk\_library** will be set to
  **zipfs:/boot/tk**.

* If the file **pkgIndex.tcl** is present, the **$dir** variable will be set to
  **zipfs:/app** and the file will be sourced as if it were a package index.

* If the file **main.tcl** is present, the file **zipfs:/app/main.tcl** will
  be registered with **Tcl\_SetStartupScript\(\)**

# Copyright

This document has been placed in the public domain.

