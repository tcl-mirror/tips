# TIP 596: Stubs support for Embedding Tcl in other applications
	Author:         Jan Nijtmans <jan.nijtmans@gmail.com>
	State:          Draft
	Type:           Project
	Tcl-Version:    9.0
	Tcl-Branch:     rfe-854941
-----
# Abstract

The Stubs mechanism was originally written to be able to extend Tcl with
binary extensions, without the extensions depending on a specific Tcl
version. But what if Tcl is being embedded inside another application?
The Stub mechanism was never designed for that.

David Gravereaux wrote a [RFE](https://core.tcl-lang.org/tcl/info/854941)
long ago (december 2003), touching on the problems arising. And Shannon Noe
wrote [TIP #531](531.md) which also was inspired on the same problem.

This TIP enhances Tcl 9.0 with no new API, but internal modifications,
such that embedding Tcl in other applications using the Stub mechanism
is finally possible without the described problems. It follows David
Gravereaux's outline, providing new wrapper functions in the stub library
(`libtcl9.0stub.a` / `tcl90stub.lib`) which are able to
locate, load and initialized the Tcl 9.0 shared library (`libtcl9.0.so`
/ `tcl90.dll`), just assuming it is somewhere on the PATH. No new
functions are added to the API, only existing functions which
previously only worked for extensions are now made
suitable to be used for Embedding applications as well.

# Specification

The following 4 functions are added to the Tcl Stub library. Their
actual name in the stub library is different, in order to prevent
symbol conflicts, but they function under the following names:

	* `Tcl_InitSubsystems()`
	* `Tcl_SetPanicProc()`
	* `Tcl_FindExecutable()`
	* `TclZipfs_AppHook()`

Any application which wants to embed Tcl only needs to call one (or more) of
those 4 functions first. If the application is compiled with `-DUSE_TCL_STUBS`,
a wrapper function is used in stead which loads the Tcl 9.0 core, initializes
it, initializes a stub table in the embedder application, and then
runs the corresponding function in the Tcl core. After that, the
embedding application can call any other functions from the Tcl API
through the stub table, everything further is fully transparent.

An example Embedding "Hello World" application:
<pre>
\#define USE\_TCL\_STUBS
\#include &lt;tcl.h>
\#include &lt;stdio.h>
int main(int argc, char **argv) {
    const char \*version = Tcl_InitSubsystems(); /\* Load/Initialize the Tcl core \*/
    if (version == NULL) printf("Cannot find the Tcl core\\n");
    Tcl_Interp *interp = Tcl_CreateInterp();
    Tcl_Eval(interp, "puts stdout {Hello World}");
    Tcl_DeleteInterp(interp);
    return 0;
}
</pre>

Compile this example application, and link it to the Tcl stub library, that's
all.

Which of the 4 functions the embedder calls first, depends on
what details are needed for the initialization. `Tcl_InitSubsystems()`
just initializes the minimum possible. `Tcl_SetPanicProc()`
can be used if the embedder provides its own panicproc. `Tcl_FindExecutable()`
is needed when the interpreter needs access to `info nameofexecutable`.
`TclZipfs_AppHook()` is needed of the embedder application has a zip-file
attached which needs to be mounted to be made available to the Tcl
interpreter. Multiple such calls can be done, if desired: the first
call will load the Tcl core, succeeding calls don't do that again.

The signature of the 4 initialization functions is changed: All
functions return a `const char *` now, which will return NULL if
locating the Tcl core fails. The functions return the full Tcl version
numnber if the initialization succeeds. This can be used to check if
the Tcl version is actually the expected one.

Since Tcl 9.0 is the only version in development after 8.7, there is no
mechanism yet to prefer Tcl 9.1 over 9.0, or make another selection
on exactly which Tcl version is desired. That exercise is left for
the future, when the development of Tcl 9.1 starts.

# Implementation

Implementation is in Tcl branch rfe-854941.

# Compatibility

This 100% upwards compatible with Tcl 8.6.

# Copyright

This document has been placed in the public domain.
